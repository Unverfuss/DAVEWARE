<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DAVEWARE™ CARD PRINTER V1</title>
  <link rel = "stylesheet" href="style.css"> 
  
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
      color: #333;
    }

    .form-container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-top: 16px;
      margin-bottom: 6px;
      font-weight: bold;
    }

    input[type="file"],
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }

    .moves {
      display: grid;
    }
    
    .button-group {
      margin-top: 24px;
      text-align: center;
    }

    button {
      padding: 12px 20px;
      font-size: 16px;
      font-family: 'Segoe UI', sans-serif;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
      margin: 0 10px;
    }

    button:hover {
      background-color: #45a049;
      transform: translateY(-2px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    canvas {
      display: block;
      margin: 40px auto;
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<canvas id="bgCanvas" style="position: fixed; top: -41px; left: 0; z-index: -1;"></canvas>  
  
<div class="form-container">
  <h1>DAVEWARE™ CARD PRINTER</h1>

  <label for="imgUpload">Upload Image:</label>
  <input type="file" id="imgUpload" accept="image/*" />

  <div class="aura-selector">
<label>Choose Aura:</label>
<div class="aura-button-wrapper">
  <img id="selectedAura" src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/autism.png" class="aura-thumb" />
  <div class="aura-options">
    <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/autism.png" data-url="autism.png">
    <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/bum.png" data-url="bum.png">
    <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/green.png" data-url="green.png">
    <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/fly.png" data-url="fly.png">
    <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/gpa.png" data-url="gpa.png">
    <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/funny.png" data-url="funny.png">
    <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/nerd.png" data-url="nerd.png">
    <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/lazy.png" data-url="lazy.png">
  </div>
</div>
</div>
  
  <div class="tier-selector" id="tierButtons">
    <button data-value="1" title="Uncommon"></button>
    <button data-value="2" title="Rare"></button>
    <button data-value="3" title="Legendary"></button>
    <button data-value="4" title="Mythical"></button>
  </div>

  <p id="tierLabel" class="tier-label">Select Rarity</p>

  <label for="cardName">Card Name:</label>
  <input type="text" id="cardName" placeholder="e.g. Happy Dave" />

  <label for="description">Description:</label>
  <textarea id="description" placeholder="e.g. A joyful and cheery Dave" rows="4" style="width: 100%;"></textarea>

    <label for="series">Series:</label>
  <input type="text" id="series" placeholder="e.g. Series 1 / DAVES" />

  <label>Moves:</label>
<div id="moves" class="moves">
  <div class="move-row">
    <input type="text" placeholder="ATK" class="move-name" />
    <input type="text" placeholder="##%" class="move-percent" />
    <input type="text" placeholder="99" class="move-number" />
  </div>
    <div class="move-row">
    <input type="text" placeholder="DEF" class="move-name" />
    <input type="text" placeholder="##%" class="move-percent" />
    <input type="text" placeholder="99" class="move-number" />
  </div>
    <div class="move-row">
    <input type="text" placeholder="ACT" class="move-name" />
    <input type="text" placeholder="##%" class="move-percent" />
    <input type="text" placeholder="99" class="move-number" />
  </div>
</div>

  <div class="yogurt-selector">
  <label>Choose Yogurt:</label>
  <div class="yogurt-button-wrapper">
    <img id="selectedYogurt" src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/yogurt/black_cherry.png" class="yogurt-thumb" />
   <div class="yogurt-options">
      <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/yogurt/black_cherry.png" data-url="black_cherry.png">
      <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/yogurt/key_lime.png" data-url="key_lime.png">
      <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/yogurt/cookie_dough.png" data-url="cookie_dough.png">
      <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/yogurt/key_lime_crumble.png" data-url="key_lime_crumble.png">
      <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/yogurt/peanut_butter_cup.png" data-url="peanut_butter_cup.png">
      <img src="https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/yogurt/strawberry_banana.png" data-url="strawberry_banana.png">
  </div>
</div>
</div>
  
<div class="number-input-wrapper">
  <label for="cardNumber">Number (15–99):</label>
  <input type="number" id="cardNumber" name="cardNumber" min="15" max="99" value="15">
</div>

  <div class="button-group">
    <button onclick="generateCard()">PRINT CARD</button>
    <button onclick="downloadCard()">DOWNLOAD CARD</button>
  </div>
</div>

<canvas id="cardCanvas" width="750" height="1050"></canvas>


</div>

<script>
  const bgCanvas = document.getElementById("bgCanvas");
  const canvas = document.getElementById("cardCanvas");
  const bgCtx = bgCanvas.getContext("2d");
  const tierButtons = document.querySelectorAll('#tierButtons button');
  const tierLabel = document.getElementById('tierLabel');

  const auraToForegroundMap = {
  "autism.png": "AUT.png",
  "bum.png": "BUM.png",
  "green.png": "GRN.png",
  "fly.png": "FLY.png",
  "gpa.png": "GPA.png",
  "funny.png": "FUN.png",
  "nerd.png": "NRD.png",
  "lazy.png": "LAZ.png"
};
  
  let rarityImageMap = {};
  const rarityBgUrls = {
    1: "https://raw.githubusercontent.com/Unverfuss/DAVEWARE/refs/heads/main/Background.png",
    2: "https://raw.githubusercontent.com/Unverfuss/DAVEWARE/refs/heads/main/Background2.png",
    3: "https://raw.githubusercontent.com/Unverfuss/DAVEWARE/refs/heads/main/Background3.png",
    4: "https://raw.githubusercontent.com/Unverfuss/DAVEWARE/refs/heads/main/Background4.png"
  };

  let selectedYogurtUrl = "https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/yogurt/black_cherry.png";
let selectedAuraUrl = "https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/autism.png";
let selectedForegroundUrl = "https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/foregrounds/AUT.png";

document.querySelectorAll('.yogurt-options img').forEach(img => {
  img.addEventListener('click', () => {
    const url = img.getAttribute('src');
    document.getElementById('selectedYogurt').src = url;
    selectedYogurtUrl = url;
  });
});

document.querySelectorAll('.aura-options img').forEach(img => {
  img.addEventListener('click', () => {
    const url = img.getAttribute('src');
    document.getElementById('selectedAura').src = url;
    selectedAuraUrl = url;

    // extract just the filename from URL
    const filename = url.split('/').pop();
    const fgFile = auraToForegroundMap[filename];
    selectedForegroundUrl = `https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/foregrounds/${fgFile}`;
  });
});
  
  
  tierButtons.forEach(button => {
    button.addEventListener('click', () => {
      const val = parseInt(button.getAttribute('data-value'));
      window.selectedScale = val;
      
    });
  });

  const tierNames = {
    1: "Uncommon",
    2: "Rare",
    3: "Legendary",
    4: "Mythical"
  };

  const tierClasses = {
    1: "uncommon",
    2: "rare",
    3: "legendary",
    4: "mythical"
  };

  tierButtons.forEach(button => {
    button.addEventListener('click', () => {
      const val = parseInt(button.getAttribute('data-value'));
      tierButtons.forEach(b => {
        const bVal = parseInt(b.getAttribute('data-value'));
        b.classList.toggle('active', bVal <= val);
      });
      tierLabel.textContent = tierNames[val];
      window.selectedTier = tierNames[val];
    });
  });

  function resizeCanvas() {
    bgCanvas.width = window.innerWidth;
    bgCanvas.height = window.innerHeight;
  }

  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  const lineColor = "#80d182";
  const backgroundColor = "#4ea364";
  const speed = 0.5;
  const spacing = 50;
  let offset = 0;

  function drawBackground() {
    bgCtx.fillStyle = backgroundColor;
    bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);

    bgCtx.strokeStyle = lineColor;
    bgCtx.lineWidth = 10;

    const diagLength = bgCanvas.width + bgCanvas.height;
    bgCtx.beginPath();

    for (let i = -diagLength; i < diagLength; i += spacing) {
      bgCtx.moveTo(i + offset, 0);
      bgCtx.lineTo(i - bgCanvas.height + offset, bgCanvas.height);
    }

    bgCtx.stroke();
  }

  function animate() {
    offset = (offset + speed) % spacing;
    drawBackground();
    requestAnimationFrame(animate);
  }

  animate();

 function downloadCard() {
  const canvas = document.getElementById("cardCanvas");
  
  // Check if the canvas is tainted
  try {
    // Attempt to export to PNG (this will throw an error if the canvas is tainted)
    const dataUrl = canvas.toDataURL("image/png");
    
    const link = document.createElement("a");
    link.download = "custom_card.png";
    link.href = dataUrl;
    link.click();
  } catch (e) {
    console.error("Failed to download canvas due to tainted canvas:", e);
    alert("Unable to download due to security restrictions. Please check the content on the canvas.");
  }
}



function drawEmbossedText(ctx, text, x, y, fontSize = 30, color = "#ffffff") {
  ctx.font = `${fontSize}px 'Comic Sans MS', cursive`;

  // Set blending mode to 'multiply' for the shadow
  ctx.globalCompositeOperation = 'darker';

  // Shadow layer (black with 50% opacity)
  ctx.fillStyle = "rgba(0, 0, 0, 0.5)";  // Black with 50% opacity
  ctx.fillText(text, x, y - 3);  // Slight offset for shadow

  // Reset blending mode to default for the text
  ctx.globalCompositeOperation = 'source-over';

  // Foreground color text
  ctx.fillStyle = color;  // Set the text color to the passed 'color' argument
  ctx.fillText(text, x, y);

   // Set blending mode to 'multiply' for the shadow
  ctx.globalCompositeOperation = 'lighter';

  // Shadow layer (black with 50% opacity)
  ctx.fillStyle = "rgba(255, 255, 255, .2)";  // Black with 50% opacity
  ctx.fillText(text, x, y + 2);  // Slight offset for shadow
  
    // Reset blending mode to default for the text
  ctx.globalCompositeOperation = 'source-over';
}
  
async function generateCard() {
  const canvas = document.getElementById("cardCanvas");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (Object.keys(rarityImageMap).length === 0) {
    await loadRarityImages(); // load images only once
  }

  const rarity = window.selectedScale || 1;
  const bg = rarityImageMap[rarity];
  ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

  const fg = await loadImage(selectedForegroundUrl);
  ctx.drawImage(fg, 19, 19, 712, 1012);

  const ib = await loadImage("https://raw.githubusercontent.com/Unverfuss/DAVEWARE/refs/heads/main/Rectangle%201.png");
  ctx.drawImage(ib, 36, 115, 679, 454);

  const b = await loadImage("https://raw.githubusercontent.com/Unverfuss/DAVEWARE/refs/heads/main/boxes.png");
  ctx.drawImage(b, 36, 23, 679, 1005);

  const thermos = await
loadImage("https://raw.githubusercontent.com/Unverfuss/DAVEWARE/refs/heads/main/thermos.png")
  ctx.drawImage(thermos, 538, 570, 99, 191)
  
  const cardNumber = document.getElementById("cardNumber").value;
  drawEmbossedText(ctx, cardNumber, 560, 720, 50, "#bd1616");
  
  const file = document.getElementById("imgUpload").files[0];
  if (file) {
    const userImg = await fileToImage(file);
    ctx.drawImage(userImg, 92, 169, 569, 345);
  }

  const msk = await loadImage("https://raw.githubusercontent.com/Unverfuss/DAVEWARE/refs/heads/main/mask.png");
  ctx.drawImage(msk, 63, 140, 625, 401);

  const empty = await loadImage("https://raw.githubusercontent.com/Unverfuss/DAVEWARE/refs/heads/main/empty_slot_1.png")
  ctx.drawImage(empty, 451, 73, 30, 30)
  ctx.drawImage(empty, 516, 73, 30, 30)
  ctx.drawImage(empty, 581, 73, 30, 30)
  ctx.drawImage(empty, 646, 73, 30, 30)

  const gem = await loadImage("https://raw.githubusercontent.com/Unverfuss/DAVEWARE/refs/heads/main/slot_1.png");
  const gemXPositions = [451, 516, 581, 646];
  for (let i = 0; i < rarity; i++) {
    ctx.drawImage(gem, gemXPositions[i], 73, 30, 30);
  }

  if (selectedYogurtUrl) {
  const yogurtImg = await loadImage(selectedYogurtUrl);
  ctx.drawImage(yogurtImg, 460, 825, 200, 160); // Adjust position and size as needed
}

  if (selectedAuraUrl) {
  const auraImg = await loadImage(selectedAuraUrl);
  ctx.drawImage(auraImg, 345, 60, 60, 60); // Adjust position as needed
}
 
  
  // Embossed Card Name
  drawEmbossedText(ctx, document.getElementById("cardName").value, 84, 100, 30);

    // Embossed Series Name
  drawEmbossedText(ctx, document.getElementById("series").value, 65, 55, 18);
  
 // Multiline Embossed Description
const descriptionText = document.getElementById("description").value;
const lines = descriptionText.split('\n');
lines.forEach((line, i) => {
  drawEmbossedText(ctx, line, 95, 830 + i * 38, 24); // Adjust Y position and font size as needed
});

  // Draw Moves with emboss
  const moveNames = document.querySelectorAll('.move-name');
  const movePercents = document.querySelectorAll('.move-percent');
  const moveNumbers = document.querySelectorAll('.move-number');

  for (let i = 0; i < moveNames.length; i++) {
    const name = moveNames[i].value || "";
    const percent = movePercents[i].value || "";
    const number = moveNumbers[i].value || "";

    const y = 620 + i * 40;

    drawEmbossedText(ctx, name, 100, y, 24);
    drawEmbossedText(ctx, percent, 320, y, 18);
    drawEmbossedText(ctx, number, 420, y, 18);
  }

  drawEmbossedText(ctx, "©2025 DAVEWARE™ / UNVERFUSS", 230, 1040, 14);
  
  canvas.classList.add("visible");
}


  async function loadRarityImages() {
    for (const key in rarityBgUrls) {
      rarityImageMap[key] = await loadImage(rarityBgUrls[key]);
    }
  }

  function fileToImage(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

  function loadImage(src) {
    return new Promise((resolve) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => resolve(img);
      img.src = src;
    });
  }

  // Set default yogurt and aura URLs
  selectedYogurtUrl = "https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/yogurt/black_cherry.png";
  selectedAuraUrl = "https://raw.githubusercontent.com/Unverfuss/DAVEWARE/main/auras/autism.png";

  // Event listeners for yogurt selection
  document.querySelectorAll('.yogurt-options img').forEach(img => {
    img.addEventListener('click', () => {
      const url = img.getAttribute('src');
      document.getElementById('selectedYogurt').src = url;
      selectedYogurtUrl = url;
    });
  });

  // Event listeners for aura selection
  document.querySelectorAll('.aura-options img').forEach(img => {
    img.addEventListener('click', () => {
      const url = img.getAttribute('src');
      document.getElementById('selectedAura').src = url;
      selectedAuraUrl = url;
    });
  });

  // Expose functions globally
  window.generateCard = generateCard;
  window.downloadCard = downloadCard;
</script>

</body>
</html>
